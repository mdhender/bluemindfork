#!/bin/bash
#BEGIN LICENSE
#
# Copyright © Blue Mind SAS, 2012
#
# This file is part of BlueMind. BlueMind is a messaging and collaborative
# solution.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of either the GNU Affero General Public License as
# published by the Free Software Foundation (version 3 of the License).
#
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
#
#
#END LICENSE

JAVA_HOME=/usr/lib/jvm/bm-jdk
jps=$JAVA_HOME/bin/jps
jmap=$JAVA_HOME/bin/jmap

function product() {
  srv=$1
  op=$2

  service $srv $op > /dev/null 2>&1
  ret=$?

  return $ret
}

start_bm() {
  echo "Start BlueMind Services"
  systemctl start bluemind.target
  return $ret
}

stop_bm() {
  echo "Stop BlueMind Services"
  systemctl stop bluemind.target
  return $ret
}

function memory_report() {
  total_mem=0
  for i in `$jps -q`; do
    used=`$jmap -histo $i 2>&1 | grep '^Total' | awk '{print $3}'`
    if [[ $used =~ ^-?[0-9]+$ ]]; then
      total_mem=$(($total_mem + $used))
      echo "Memory used for $i: $used"
    fi
  done
  mega=$(($total_mem / 1024 / 1024))
  echo "Total Blue Mind JVM memory: $total_mem ($mega MB)"
}

# Wainting for https://github.com/systemd/systemd/issues/3174
function status_bm() {
  if systemctl status bluemind.target > /dev/null 2>&1; then
    status_bm_started
  else
    status_bm_stopped
  fi
}

function status_bm_stopped() {
  ret=0
  for service in $(systemctl list-dependencies --plain bluemind.target|grep -v bluemind.target | sort | uniq); do
    if systemctl status ${service} > /dev/null 2>&1; then
      ret=1
      echo ${service}" started while BlueMind is stopped - please restart bluemind: systemctl restart bluemind.target"
    fi
  done
  
  return ${ret}
}

function status_bm_started() {
  ret=0
  for service in $(systemctl list-dependencies --plain bluemind.target|grep -v bluemind.target | sort | uniq); do
    if ! [ -e "/etc/bm/"$(echo ${service} | sed -e 's/\.service$/.disabled/') ] \
        && ! systemctl status ${service} > /dev/null 2>&1; then
      ret=1
      echo ${service}" fail - check systemctl status "${service}" and journalctl -xe -u "${service}
    fi
  done
  
  return ${ret}
}

help() {
  echo "Usage: "$0" [start|stop|status|reload|restart|all_status|memory]"
  echo -e "\tstart: start Blue Mind services"
  echo -e "\tstop: stop Blue Mind services"
  echo -e "\tstatus: display Blue Mind core service status"
  echo -e "\treload|restart: restart Blue Mind services"
  echo -e "\tmemory: display Blue Mind memory usage"
}

case "$1" in
  start)
      start_bm
      ;;
  stop)
      stop_bm
      ;;
  status|all_status)
      status_bm
      ;;
  reload)
      stop_bm
      start_bm
      ;;
  restart)
      stop_bm
      start_bm
      ;;
  memory)
      memory_report
      ;;
  *)
      help
      ;;
esac
