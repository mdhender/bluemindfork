# Blue Mind client access proxy
server {
  listen   80 default_server;
  include /etc/nginx/bm-servername.conf;
  include /etc/nginx/bm-externalurl.conf;

  location / {
    return 301 https://$bmexternalurl$request_uri;
  }

  location /nginx_status {
    stub_status on;
    access_log off;
    allow 127.0.0.1;
    deny all;
  }
}

upstream hps {
  ip_hash;
  include /etc/bm-hps/bm-upstream-hps.conf;
}

upstream webserver {
  ip_hash;
  include /etc/bm-webserver/bm-upstream-webserver.conf;
}

upstream core {
  ip_hash;
  include /etc/bm-core/bm-upstream-core.conf;
}

upstream mapi {
  ip_hash;
  include /etc/bm-mapi/bm-upstream-mapi.conf;
}

upstream eas {
  ip_hash;
  include /etc/bm-eas/bm-upstream-eas.conf;
}

upstream tick {
  ip_hash;
  include /etc/bm-tick/bm-upstream-tick.conf;
}

upstream mainnginx {
  ip_hash;
  include /etc/nginx/bm-upstream-mainnginx.conf;
}

upstream sentry {
  ip_hash;
  include /etc/nginx/bm-upstream-sentry.conf;
}

server {
  include /etc/nginx/bm-nginx-role.conf;

  set $bm_upstream_hps http://hps;
  set $bm_upstream_webserver http://webserver;
  set $bm_upstream_core http://core;
  set $bm_upstream_mapi http://mapi;
  set $bm_upstream_eas http://eas;
  set $bm_upstream_tick http://tick;
  set $bm_upstream_sentry https://sentry;

  if ($bm_nginx_role = "edge") {
    set $bm_upstream_hps https://mainnginx;
    set $bm_upstream_webserver https://mainnginx;
    set $bm_upstream_core https://mainnginx;
    set $bm_upstream_mapi https://mainnginx;
    set $bm_upstream_eas https://mainnginx;
    set $bm_upstream_tick https://mainnginx;
    set $bm_upstream_sentry https://mainnginx;
  }

  listen   443 ssl http2 default_server;
  include /etc/nginx/bm-servername.conf;
  include /etc/nginx/bm-externalurl.conf;

  ssl_certificate  /etc/ssl/certs/bm_cert.pem;
  ssl_certificate_key  /etc/ssl/certs/bm_cert.pem;

  ssl_session_timeout  5m;
  # use bettercrypto.org recommanded settings
  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
  ssl_prefer_server_ciphers off;
  ssl_dhparam /etc/nginx/bm_dhparam.pem;

  # Allow througth iFrame
  include /etc/nginx/bm-nginx-embed.conf;
  set $bm_xframeoptions SAMEORIGIN;
  set $bm_proxycookiepath "";
  if ($bm_nginx_embed = "true") {
    set $bm_xframeoptions "";
    set $bm_proxycookiepath "; SameSite=None";
  }
  add_header X-Frame-Options $bm_xframeoptions;
  proxy_cookie_path ~^(.+)$ $1$bm_proxycookiepath;

  add_header Strict-Transport-Security max-age=15768000; # six months
  add_header X-Content-Type-Options nosniff;
  add_header 'Referrer-Policy' 'strict-origin-when-cross-origin';
  add_header X-XSS-Protection "1; mode=block";
  add_header X-Robots-Tag noindex;
  error_page 403 /errors-pages/403.html;
  error_page 404 /errors-pages/404.html;
  error_page 500 /errors-pages/500.html;
  error_page 502 /errors-pages/502.html;
  error_page 503 /errors-pages/maintenance.html;
  error_page 504 /errors-pages/504.html;
  proxy_set_header        X-Real-IP       $remote_addr;
  proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;

  location / {
    if ($uri ~ ^/errors-pages) {
      break;
    }

    proxy_intercept_errors on;
    proxy_pass $bm_upstream_hps$uri$is_args$args;
  }

  location /robots.txt {
    alias /usr/share/bm-client-access/robots.txt;
  }


  location /errors-pages {
    alias /usr/share/bm-client-access/errors-pages;
  }

  location /templates/ {
    proxy_pass $bm_upstream_hps;
    proxy_intercept_errors on;
  }

  location /webmail/images/ {
    gzip             on;
    gzip_min_length  1000;
    gzip_proxied     any;
    gzip_types       text/plain application/xml text/css text/javascript application/javascript text/json application/json;
    gzip_comp_level 6;
    proxy_pass $bm_upstream_webserver;
    proxy_intercept_errors on;
  }

  location ~ ^/webmail/plugins/bm_webmail/(.*)$ {
    gzip             on;
    gzip_min_length  1000;
    gzip_proxied     any;
    gzip_types       text/plain application/xml text/css text/javascript application/javascript text/json application/json;
    gzip_comp_level 6;

    set $bm_request_uri /webmail/$1;
    if ($bm_nginx_role = "edge") {
      set $bm_request_uri $request_uri;
    }

    proxy_pass $bm_upstream_webserver$bm_request_uri;
    proxy_intercept_errors on;
  }

  location /webmail/ {
    include /etc/bm-webmail/nginx-webmail.conf;
    proxy_pass $bm_upstream_hps;
    proxy_intercept_errors on;
  }

  location /adminconsole/ {
    gzip             on;
    gzip_min_length  1000;
    gzip_proxied     any;
    gzip_types       text/plain application/xml text/css text/javascript application/javascript text/json application/json;
    gzip_comp_level 6;

    proxy_pass $bm_upstream_hps;
    client_max_body_size 10m;
    proxy_intercept_errors on;
  }

  location /setup/ {
    set $bm_auth_basic "BlueMind Setup";
    if ($bm_nginx_role = "edge") {
      set $bm_auth_basic off;
    }

    auth_basic $bm_auth_basic;
    auth_basic_user_file  /etc/nginx/sw.htpasswd;

    proxy_pass $bm_upstream_webserver;
    proxy_intercept_errors on;
    error_page 401 /errors-pages/401.html;
  }

  location /bm-push/ {
    proxy_pass $bm_upstream_webserver;
  }

  location /input/ {
    proxy_pass $bm_upstream_core;
  }

  location /eventbus/ {
    proxy_pass $bm_upstream_core;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }

  location ~ ^/Autodiscover(.*)$ {
    set $bm_request_uri /autodiscover$1;
    proxy_pass $bm_upstream_mapi$bm_request_uri;
    proxy_http_version 1.1;
  }

  location /autodiscover {
    proxy_pass $bm_upstream_mapi;
    proxy_http_version 1.1;
  }

  location /ews {
    proxy_pass $bm_upstream_mapi;
    proxy_http_version 1.1;
  }

  location ~ ^/EWS(.*)$ {
    set $bm_request_uri /ews$1;
    proxy_pass $bm_upstream_mapi$bm_request_uri;
    proxy_http_version 1.1;
  }

  location /OAB {
     proxy_pass $bm_upstream_mapi;
     proxy_http_version 1.1;
  }

  location /app_marketplace {
     proxy_pass $bm_upstream_mapi;
     proxy_http_version 1.1;
  }

  location /mapi {
     proxy_pass $bm_upstream_mapi;
     proxy_http_version 1.1;
  }

  location /Microsoft-Server-ActiveSync {
    include /etc/bm-eas/bm-eas-nginx.conf;
    proxy_pass $bm_upstream_eas;
    proxy_read_timeout 1200s;
    proxy_pass_header Server;
    proxy_http_version 1.1;

    gzip             on;
    gzip_proxied     any;
    gzip_types       application/vnd.ms-sync.wbxml;
    gzip_comp_level 6;

  }

  location /.well-known/caldav {
    proxy_pass $bm_upstream_webserver;
  }

  location /.well-known/carddav {
    proxy_pass $bm_upstream_webserver;
  }

  location /dav {
    proxy_pass $bm_upstream_webserver;
    proxy_http_version 1.1;
    client_max_body_size 10m;
  }

  location /cal/ {
    gzip             on;
    gzip_min_length  1000;
    gzip_proxied     any;
    gzip_types       text/plain application/xml text/css text/javascript application/javascript text/json application/json;
    gzip_comp_level 6;

    if ($request_method = PROPFIND) {
       return 400;
    }

    proxy_pass $bm_upstream_hps;
    client_max_body_size 20m;
    proxy_intercept_errors on;
  }

  location /contact/ {
    gzip             on;
    gzip_min_length  1000;
    gzip_proxied     any;
    gzip_types       text/plain application/xml text/css text/javascript application/javascript text/json application/json;
    gzip_comp_level 6;

    proxy_pass $bm_upstream_hps;
    client_max_body_size 10m;
    proxy_intercept_errors on;
  }

  location /settings/ {
    gzip             on;
    gzip_min_length  1000;
    gzip_proxied     any;
    gzip_types       text/plain application/xml text/css text/javascript application/javascript text/json application/json;
    gzip_comp_level 6;

    proxy_pass $bm_upstream_hps;
    client_max_body_size 10m;
    proxy_intercept_errors on;
  }

  location /im/ {
    gzip             on;
    gzip_min_length  1000;
    gzip_proxied     any;
    gzip_types       text/plain application/xml text/css text/javascript application/javascript text/json application/json;
    gzip_comp_level 6;

    proxy_pass $bm_upstream_hps;
    proxy_intercept_errors on;
  }

  location /task/ {
    gzip             on;
    gzip_min_length  1000;
    gzip_proxied     any;
    gzip_types       text/plain application/xml text/css text/javascript application/javascript text/json application/json;
    gzip_comp_level 6;

    proxy_pass $bm_upstream_hps;
    proxy_intercept_errors on;
  }

  location /chooser/ {
    gzip             on;
    gzip_min_length  1000;
    gzip_proxied     any;
    gzip_types       text/plain application/xml text/css text/javascript application/javascript text/json application/json;
    gzip_comp_level 6;

    proxy_pass $bm_upstream_hps;
    proxy_intercept_errors on;
  }

  # core json-rpc
  location /api/ {
    gzip             on;
    gzip_min_length  1000;
    gzip_proxied     any;
    gzip_types       text/plain application/xml text/css text/javascript application/javascript text/json application/json;
    gzip_comp_level 6;

    proxy_pass $bm_upstream_core;
    proxy_http_version 1.1;
    client_max_body_size 10m;
    proxy_buffering off;
  }

  location /api/filehosting/ {
    include /etc/bm-webmail/bm-filehosting.conf;
    proxy_pass $bm_upstream_core;
    proxy_http_version 1.1;
    proxy_buffering off;
  }

  location /api/attachment/ {
    include /etc/bm-webmail/bm-filehosting.conf;
    proxy_pass $bm_upstream_core;
    proxy_http_version 1.1;
    proxy_buffering off;
  }

  location /fh/ {
    proxy_pass $bm_upstream_webserver;
    proxy_http_version 1.1;
    proxy_buffering off;
  }

  location /docs/ {
    gzip             on;
    gzip_min_length  1000;
    gzip_proxied     any;
    gzip_types       text/plain application/xml text/css text/javascript application/javascript text/json application/json;
    gzip_comp_level 6;

    proxy_pass $bm_upstream_hps;
    client_max_body_size 10m;
    proxy_intercept_errors on;
  }

  location  /calendar/publish/ {
    set $bm_request_uri /cal$request_uri;
    proxy_pass $bm_upstream_webserver$bm_request_uri;
    proxy_http_version 1.1;
  }

  location /webapp/ {
    gzip             on;
    gzip_min_length  1000;
    gzip_proxied     any;
    gzip_types       text/plain application/xml text/css text/javascript text/json application/json;
    gzip_disable     "MSIE [1-6]\.";
    gzip_comp_level 6;
    proxy_intercept_errors on;
    #All url not served by webserver are handled by the in-app router
    error_page 404 =200 /webapp/index.html;

    proxy_pass $bm_upstream_hps;
  }

  location /tick/ {
    set $bm_auth_basic "BlueMind Tick";
    if ($bm_nginx_role = "edge") {
      set $bm_auth_basic off;
    }

    auth_basic $bm_auth_basic;
    auth_basic_user_file  /etc/nginx/sw.htpasswd;

    gzip             on;
    gzip_min_length  1000;
    gzip_proxied     any;
    gzip_types       text/plain application/xml text/css text/javascript text/json application/json;
    gzip_comp_level 6;

    proxy_http_version 1.1;
    proxy_pass $bm_upstream_tick;
  }

  location /native {
    return 301 https://$bmexternalurl/login/native;
  }

  location /sentry/ {
    include /etc/nginx/bm-sentry.conf;
    proxy_buffering off;
    proxy_set_header Host $bm_sentry_host;
    proxy_set_header X-Real-IP $remote_addr;
    rewrite /sentry/(.*) /$1 break;
    proxy_pass $bm_upstream_sentry;
  }

  # Must be the last directive
  include /etc/nginx/bm-local.d/*.conf;
}
