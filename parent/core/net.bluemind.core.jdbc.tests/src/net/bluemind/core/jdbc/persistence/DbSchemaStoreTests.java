/* BEGIN LICENSE
 * Copyright Â© Blue Mind SAS, 2012-2016
 *
 * This file is part of BlueMind. BlueMind is a messaging and collaborative
 * solution.
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of either the GNU Affero General Public License as
 * published by the Free Software Foundation (version 3 of the License).
 *
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 *
 * See LICENSE.txt
 * END LICENSE
 */
package net.bluemind.core.jdbc.persistence;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertNotNull;
import static org.junit.Assert.assertNull;
import static org.junit.Assert.fail;

import java.io.InputStream;
import java.net.MalformedURLException;
import java.net.URL;
import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.Arrays;
import java.util.concurrent.atomic.AtomicInteger;

import javax.sql.DataSource;

import org.eclipse.core.runtime.Platform;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;
import org.osgi.framework.Bundle;

import com.google.common.io.ByteStreams;

import net.bluemind.core.jdbc.JdbcAbstractStore;
import net.bluemind.core.jdbc.JdbcException;
import net.bluemind.core.jdbc.JdbcHelper;
import net.bluemind.core.jdbc.JdbcTestHelper;
import net.bluemind.core.jdbc.SchemaDescriptor;

public class DbSchemaStoreTests {

	private DbSchemaStore schemaStore;
	private SchemaDescriptor sampleDescriptor;
	private DataSource ds;

	@Before
	public void before() throws Exception {
		JdbcTestHelper.getInstance().initPools();

		ds = JdbcTestHelper.getInstance().getDataSource();
		Bundle bundle = Platform.getBundle("net.bluemind.core.sqlschema");
		assertNotNull(bundle);

		URL url = bundle.getResource("sql/schema-version-0.0.1.sql");
		assertNotNull(url);
		String schemaVersion = null;
		try (InputStream in = url.openStream()) {
			byte[] b = ByteStreams.toByteArray(in);
			schemaVersion = new String(b);
		}

		Connection con = null;
		Statement st = null;
		try {
			con = ds.getConnection();
			st = con.createStatement();
			st.execute(schemaVersion);
		} finally {
			JdbcHelper.cleanup(con, null, st);
		}
		sampleDescriptor = new SchemaDescriptor("test", "2.3.0", new URL("file:sql/test-2.3.0.sql"),
				Arrays.<String>asList(), false);

		schemaStore = new DbSchemaStore(JdbcTestHelper.getInstance().getDataSource());
	}

	@After
	public void after() throws Exception {
		JdbcTestHelper.getInstance().afterTest();
	}

	@Test
	public void testCreateSchema() throws MalformedURLException {
		schemaStore.createSchema(sampleDescriptor);

		// check table unittest is created
		Connection con = null;
		Statement st = null;
		ResultSet rs = null;
		try {
			con = ds.getConnection();
			st = con.createStatement();
			rs = st.executeQuery("select * from unittest");
		} catch (SQLException e) {
			fail(e.getMessage());
		} finally {
			JdbcHelper.cleanup(con, rs, st);
		}

		try {
			schemaStore.createSchema(sampleDescriptor);
			fail("cant create a schema 2 times");
		} catch (JdbcException e) {
		}
	}

	@Test
	public void testGetVersion() throws MalformedURLException {
		String version = schemaStore.getSchemaVersion(sampleDescriptor.getName());
		// schema is not yet created
		assertNull(version);
		schemaStore.createSchema(sampleDescriptor);
		version = schemaStore.getSchemaVersion(sampleDescriptor.getName());
		assertEquals(sampleDescriptor.getVersion(), version);
	}

	@Test
	public void testDeadlock() throws InterruptedException, SQLException {
		AtomicInteger errors = new AtomicInteger(0);

		try (Connection con = ds.getConnection(); Statement stmt = con.createStatement()) {
			stmt.execute("CREATE TABLE deadlocktest (id int, v text)");
			stmt.execute("INSERT INTO deadlocktest values (1, 'w1')");
			stmt.execute("INSERT INTO deadlocktest values (2, 'w2')");
		}

		Thread t1 = new Thread(() -> {
			try (Connection con = ds.getConnection(); Statement st = con.createStatement()) {
				con.setAutoCommit(false);
				JdbcAbstractStore.retryOnDeadlock(() -> {
					st.execute("UPDATE deadlocktest set v='w1' where id=1");
					st.execute("select pg_sleep(1)");
					st.execute("UPDATE deadlocktest set v='w2' where id=2");
					st.execute("select pg_sleep(2)");
					return null;
				});
			} catch (Exception e) {
				errors.addAndGet(1);
				e.printStackTrace();
			}
		});

		Thread t2 = new Thread(() -> {
			try (Connection con = ds.getConnection(); Statement st = con.createStatement()) {
				con.setAutoCommit(false);
				JdbcAbstractStore.retryOnDeadlock(() -> {
					st.execute("UPDATE deadlocktest set v='w2' where id=2");
					st.execute("select pg_sleep(1)");
					st.execute("UPDATE deadlocktest set v='w1' where id=1");
					st.execute("select pg_sleep(2)");
					return null;
				});

			} catch (Exception e) {
				errors.addAndGet(1);
				e.printStackTrace();
			}
		});
		t1.start();
		t2.start();
		t1.join();
		t2.join();

		assertEquals(1, errors.get());
	}
}
